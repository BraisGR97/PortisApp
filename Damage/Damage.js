// Damage.js - L√≥gica para la p√°gina de detalle de una sola aver√≠a

let currentDamageId = null;
let currentInitialObservations = '';
let currentRepairData = null; // CLAVE: Variable global para almacenar los datos completos de la reparaci√≥n
let currentAction = ''; // Almacena la acci√≥n actual del modal ('delete' o 'complete')

// --- L√ìGICA DEL MODAL DE CONFIRMACI√ìN GLASSMORPHISM ---

// Referencias al DOM del modal (se inicializan en initializePageLogic)
let modal, modalTitle, modalMessage, btnYes, btnNo, btnCancel;

/** Muestra el modal de confirmaci√≥n con mensajes espec√≠ficos. */
function showConfirmationModal(actionType) {
    if (!modal) return; // Validaci√≥n defensiva

    currentAction = actionType;
    modal.classList.remove('hidden'); // Muestra el overlay
    modal.focus(); // Asegura que el modal capture eventos si es necesario

    // Configura el modal basado en la acci√≥n
    if (actionType === 'delete') {
        modalTitle.textContent = '¬°ATENCI√ìN! Eliminar Aver√≠a';
        modalMessage.textContent = 'Est√°s seguro de que deseas ELIMINAR permanentemente esta aver√≠a?';
        btnYes.textContent = 'S√≠, Eliminar';
        btnNo.textContent = 'No';
        btnCancel.classList.add('hidden'); // Ocultar Cancelar en la acci√≥n de Eliminar
        btnNo.style.display = 'inline-block'; // Asegurar que 'No' se muestre

    } else if (actionType === 'complete') {
        // Validaci√≥n: no permitir completar en modo edici√≥n
        const editDetailsBtn = document.getElementById('editDetailsBtn');
        if (editDetailsBtn && editDetailsBtn.classList.contains('active')) {
            showMessageBox("Desactiva el modo edici√≥n para completar o registrar la aver√≠a.", true);
            modal.classList.add('hidden'); // Asegurarse de que est√© oculto si se cancela la apertura
            return;
        }

        modalTitle.textContent = 'Completar Aver√≠a';
        modalMessage.textContent = 'La aver√≠a ha sido resuelta (SI) o solo deseas registrar el mantenimiento (NO)?';
        btnYes.textContent = 'S√≠ (Resuelta)';
        btnNo.textContent = 'No (Solo Registrar)';
        btnCancel.textContent = 'Cancelar';
        btnCancel.classList.remove('hidden'); // Mostrar Cancelar
        btnNo.style.display = 'inline-block';
    }
}

/** Oculta el modal de confirmaci√≥n. */
function hideConfirmationModal() {
    if (modal) {
        modal.classList.add('hidden');
        // üî• IMPORTANTE: Eliminamos el reset de currentAction de aqu√≠.
    }
}

/**
 * Maneja la respuesta del usuario (S√≠/No) y ejecuta la acci√≥n.
 * @param {boolean} confirmed - true si pulsa S√≠; false si pulsa No.
 */
function handleConfirmation(confirmed) {
    // 1. Cerrar Modal
    hideConfirmationModal(); 

    console.log(`DEBUG: currentAction despu√©s de cerrar modal: ${currentAction}`); // Log para depurar

    if (!currentRepairData) {
        showMessageBox("Error: Datos de aver√≠a no cargados.", true);
        currentAction = ''; // Resetear antes de salir por error
        return;
    }

    if (currentAction === 'delete') {
        if (confirmed) {
            // **CLAVE:** Si es 'delete' y 'S√≠', ejecuta la eliminaci√≥n
            handleDeleteDamage(true); 
        } else {
            // Si el modal es de eliminaci√≥n y el usuario pulsa 'No'
            showMessageBox('Eliminaci√≥n cancelada.', false);
        }
    } else if (currentAction === 'complete') {
        // ... L√≥gica de Completado ...
        completeRepair(confirmed, currentRepairData);
    }

    // 2. üî• CORRECCI√ìN: Resetear la acci√≥n al final, despu√©s de que se haya procesado.
    currentAction = ''; 
}

// --- L√ìGICA DE ELIMINACI√ìN (Ahora con mensajes y redirecci√≥n) ---

/** Maneja la eliminaci√≥n de la aver√≠a.
 * @param {boolean} isConfirmedByModal - Indica si la acci√≥n ha sido confirmada por el modal.
 */
async function handleDeleteDamage(isConfirmedByModal) {
    console.log("DEBUG: Entrando a handleDeleteDamage. Confirmado:", isConfirmedByModal); 
    console.log("DEBUG: currentDamageId actual:", currentDamageId);
    
    // 1. Validar que la acci√≥n fue confirmada y que tenemos un ID
    if (!currentDamageId || !isConfirmedByModal) {
        console.error("ERROR: No se puede eliminar. currentDamageId es nulo o la acci√≥n no fue confirmada.");
        showMessageBox("‚ùå Error interno: No se encontr√≥ la ID de la aver√≠a para eliminar.", true);
        return; 
    }

    const db = window.db;
    // La colecci√≥n 'repairs' y el ID del documento
    const repairDocRef = window.doc(db, 'repairs', currentDamageId);
    
    try {
        // 2. Mostrar mensaje de "Eliminando..."
        showMessageBox("Eliminando aver√≠a...", false);
        
        // 3. Eliminar de Firestore
        await window.deleteDoc(repairDocRef);
        
        // 4. Mostrar mensaje de √©xito
        showMessageBox("‚úÖ Aver√≠a eliminada con √©xito. Redirigiendo...", false);
        
        // 5. Redirigir a Repairs.html despu√©s de 1.5 segundos
        setTimeout(() => {
            window.location.href = '../Repairs/Repairs.html'; 
        }, 1500); 
        
    } catch (error) {
        console.error("FIREBASE ERROR: Error al eliminar:", error);
        // Manejo de errores espec√≠ficos y gen√©ricos
        let errorMessage = `Error al eliminar: ${error.message}`;
        if (error.message.includes('Missing or insufficient permissions')) {
             errorMessage = "Error de Permisos: Revisa las reglas de Firestore (allow delete).";
        }
        showMessageBox(`‚ùå ${errorMessage}`, true);
    }
}


// --- Utilidades del DOM (Funciones auxiliares) ---

function showMessageBox(message, isError = true) {
    const msgBox = document.getElementById('damageMessageBox');
    if (!msgBox) return;

    msgBox.textContent = message;
    msgBox.classList.remove('hidden', 'error', 'success');
    
    if (!isError) {
        msgBox.classList.add('success');
        msgBox.classList.remove('error');
    } else {
        msgBox.classList.add('error');
        msgBox.classList.remove('success');
    }
    
    setTimeout(() => {
        msgBox.classList.add('hidden');
    }, 5000);
}

/** Rellena los elementos de vista (no editables) con los datos. */
function fillDetailView(data) {
    const dateParts = data.fecha ? data.fecha.split('-') : [];
    const formattedDate = dateParts.length === 2 ? `${dateParts[1]}/${dateParts[0]}` : 'Fecha Desconocida';

    const ubicacion = document.getElementById('detailUbicacion');
    const modelo = document.getElementById('detailModelo');
    const llave = document.getElementById('detailLlave');
    const contrato = document.getElementById('detailContrato');
    const fecha = document.getElementById('detailFecha');
    const averia = document.getElementById('detailAveria');
    
    if (ubicacion) ubicacion.textContent = data.ubicacion || 'N/A';
    if (modelo) modelo.textContent = data.modelo || 'N/A';
    if (llave) llave.textContent = data.llave || 'N/A';
    if (contrato) contrato.textContent = data.contrato || 'N/A';
    if (fecha) fecha.textContent = formattedDate;
    if (averia) averia.textContent = data.averia || 'N/A';
}

/** Rellena los campos de input (editables) con los datos. */
function fillInputFields(data) {
    const inputUbicacion = document.getElementById('inputUbicacion');
    const inputModelo = document.getElementById('inputModelo');
    const inputLlave = document.getElementById('inputLlave');
    const inputContrato = document.getElementById('inputContrato');
    const inputFecha = document.getElementById('inputFecha');
    const inputAveria = document.getElementById('inputAveria');
    const observationsTextarea = document.getElementById('detailObservaciones');
    
    if (inputUbicacion) inputUbicacion.value = data.ubicacion || '';
    if (inputModelo) inputModelo.value = data.modelo || '';
    if (inputLlave) inputLlave.value = data.llave || '';
    if (inputContrato) inputContrato.value = data.contrato || '';
    if (inputFecha) inputFecha.value = data.fecha || '';
    if (inputAveria) inputAveria.value = data.averia || '';
    
    if (observationsTextarea) {
        observationsTextarea.value = data.observaciones || '';
        currentInitialObservations = observationsTextarea.value; 
    }
}

/** Habilita/Deshabilita el modo edici√≥n para los campos principales. */
function enableEditMode(enable) {
    // Obtenemos las referencias del DOM en cada llamada para mayor seguridad
    const detailView = document.getElementById('detailView');
    const editForm = document.getElementById('editDamageForm');
    const savePrimaryBtn = document.getElementById('savePrimaryDetailsBtn');
    const editDetailsBtn = document.getElementById('editDetailsBtn');
    
    if (enable) {
        if (detailView) detailView.classList.add('hidden');
        if (editForm) editForm.classList.remove('hidden');
        if (savePrimaryBtn) savePrimaryBtn.classList.remove('hidden');
        if (editDetailsBtn) editDetailsBtn.classList.add('active');
        showMessageBox("Modo edici√≥n activado. Pulsa 'Guardar Cambios' para aplicar.", false);
    } else {
        if (detailView) detailView.classList.remove('hidden');
        if (editForm) editForm.classList.add('hidden');
        if (savePrimaryBtn) savePrimaryBtn.classList.add('hidden');
        if (editDetailsBtn) editDetailsBtn.classList.remove('active');
        
        const msgBox = document.getElementById('damageMessageBox');
        if (msgBox && !msgBox.textContent.includes("guardado con √©xito")) {
            showMessageBox("Modo edici√≥n desactivado.", false); 
        }
    }
}

// --- L√≥gica de Datos ---

/** Obtiene el ID de la aver√≠a de la URL. */
function getDamageIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
}

/** Carga los datos espec√≠ficos de la aver√≠a desde Firestore. */
async function loadDamageDetails() {
    currentDamageId = getDamageIdFromUrl();
    
    if (!currentDamageId) {
        const ubicacion = document.getElementById('detailUbicacion');
        if (ubicacion) ubicacion.textContent = "Error: ID de aver√≠a no encontrado.";
        showMessageBox("No se pudo cargar la aver√≠a. Falta el ID en la URL.", true);
        return;
    }
    
    const db = window.db;
    const damageDocRef = window.doc(db, 'repairs', currentDamageId);

    try {
        const docSnap = await window.getDoc(damageDocRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // CLAVE: Almacenar los datos completos globalmente
            currentRepairData = { id: docSnap.id, ...data }; 
            
            fillDetailView(data);
            fillInputFields(data);
            
            // Asegurarse de que al cargar, siempre se inicie en modo NO edici√≥n.
            enableEditMode(false); 
        } else {
            const ubicacion = document.getElementById('detailUbicacion');
            if (ubicacion) ubicacion.textContent = `Error: No existe aver√≠a con ID ${currentDamageId}`;
            showMessageBox("Aver√≠a no encontrada en la base de datos.", true);
        }
    } catch (error) {
        console.error("Error al cargar detalles de la aver√≠a:", error);
        showMessageBox(`Error de conexi√≥n al cargar: ${error.message}`, true);
    }
}

/** Maneja el guardado de los campos principales de la aver√≠a. */
async function handleSavePrimaryDetails(event) {
    event.preventDefault();
    const repairId = currentDamageId;
    const submitBtn = document.getElementById('savePrimaryDetailsBtn');
    if (!submitBtn) return; // Validaci√≥n defensiva
    submitBtn.disabled = true;

    if (!repairId) {
        showMessageBox("Error: ID de aver√≠a no encontrado.", true);
        submitBtn.disabled = false;
        return;
    }

    showMessageBox("Guardando cambios principales...", false);

    const updatedData = {
        ubicacion: document.getElementById('inputUbicacion')?.value || '',
        modelo: document.getElementById('inputModelo')?.value || '',
        llave: document.getElementById('inputLlave')?.value || '',
        contrato: document.getElementById('inputContrato')?.value || '',
        fecha: document.getElementById('inputFecha')?.value || '',
        averia: document.getElementById('inputAveria')?.value || '',
        updatedAt: new Date().toISOString()
    };
    
    const db = window.db;
    const repairDocRef = window.doc(db, 'repairs', repairId);

    try {
        await window.updateDoc(repairDocRef, updatedData);
        
        showMessageBox("Cambios guardados con √©xito.", false);
        
        // IMPORTANTE: Actualizar la variable global
        currentRepairData = { ...currentRepairData, ...updatedData };
        
        enableEditMode(false);
        fillDetailView(updatedData);
        
    } catch (error) {
        console.error("Error al actualizar detalles:", error);
        showMessageBox(`Error al guardar: ${error.message}`, true);
    } finally {
        setTimeout(() => { submitBtn.disabled = false; }, 1000);
    }
}

/** Guarda las observaciones editadas de la reparaci√≥n. */
async function handleSaveObservations(event) {
    event.preventDefault();
    const repairId = currentDamageId;
    const submitBtn = document.getElementById('saveObservationsBtn');
    if (!submitBtn) return; // Validaci√≥n defensiva
    submitBtn.disabled = true;

    if (!repairId) {
        showMessageBox("Error: ID de aver√≠a no encontrado.", true);
        submitBtn.disabled = false;
        return;
    }

    showMessageBox("Guardando observaciones...", false);
    
    const observationsTextarea = document.getElementById('detailObservaciones');
    const newObservations = observationsTextarea ? observationsTextarea.value : '';
    
    const db = window.db;
    const repairDocRef = window.doc(db, 'repairs', repairId); 

    try {
        await window.updateDoc(repairDocRef, {
            observaciones: newObservations,
            updatedAt: new Date().toISOString()
        });
        
        showMessageBox("Observaciones guardadas con √©xito.", false);
        document.getElementById('saveObservationsBtn')?.classList.add('hidden');
        currentInitialObservations = newObservations;
        
        // IMPORTANTE: Actualizar la variable global
        if (currentRepairData) {
            currentRepairData.observaciones = newObservations;
        }
        
    } catch (error) {
        console.error("Error al actualizar observaciones:", error);
        showMessageBox(`Error al guardar: ${error.message}`, true);
    } finally {
        setTimeout(() => { submitBtn.disabled = false; }, 1000);
    }
}

// --- L√≥gica de Completar Reparaci√≥n ---

/** Calcula la nueva fecha de la pr√≥xima reparaci√≥n/mantenimiento. */
function calculateNewDate(currentFecha, contrato) {
    if (!currentFecha || !contrato) return currentFecha;

    const [yearStr, monthStr] = currentFecha.split('-');
    const currentYear = parseInt(yearStr, 10);
    const currentMonth = parseInt(monthStr, 10); 

    let monthsToAdd = 0;
    switch (contrato.toLowerCase()) {
        case 'anual': monthsToAdd = 12; break;
        case 'semestral': monthsToAdd = 6; break;
        case 'trimestral': monthsToAdd = 3; break;
        default: monthsToAdd = 1; break;
    }

    let newMonth = currentMonth + monthsToAdd;
    let newYear = currentYear;

    while (newMonth > 12) {
        newMonth -= 12;
        newYear += 1;
    }

    const newMonthStr = String(newMonth).padStart(2, '0');
    return `${newYear}-${newMonthStr}`;
}

/** Maneja el proceso de completar o registrar la aver√≠a en el historial. */
async function completeRepair(isCompleted, currentRepairData) {
    const db = window.db;
    const repairId = currentRepairData.id;
    const currentFecha = currentRepairData.fecha;
    const contrato = currentRepairData.contrato;
    const currentUser = window.CURRENT_USER_ID || 'anonimo'; 

    showMessageBox("Procesando registro y actualizaci√≥n...", false);

    try {
        // --- 1. PREPARAR DATOS PARA EL REGISTRO DE HISTORIAL (/records) ---
        const recordData = {
            ...currentRepairData,
            completedAt: new Date().toISOString(), 
            isCompletedSuccessfully: isCompleted, 
            username: currentUser, 
        };
        delete recordData.id; // Eliminar ID original para que Firestore genere uno nuevo

        // --- 2. PREPARAR DATOS PARA LA ACTUALIZACI√ìN DE LA REPARACI√ìN (/repairs) ---
        const newFecha = calculateNewDate(currentFecha, contrato);

        let updateData = {
            fecha: newFecha,
            updatedAt: new Date().toISOString()
        };

        if (isCompleted) {
            // Si pulsa 'S√≠', se borra el contenido de 'averia' y 'observaciones'
            updateData.averia = "";
            updateData.observaciones = "";
        }
        
        // --- 3. EJECUTAR LA TRANSACCI√ìN DE FIREBASE ---
        const recordsCollectionRef = window.collection(db, 'records');
        await window.addDoc(recordsCollectionRef, recordData); 
        
        const repairDocRef = window.doc(db, 'repairs', repairId);
        await window.updateDoc(repairDocRef, updateData);
        
        // --- 4. FINALIZACI√ìN ---
        const completionStatus = isCompleted ? "y la aver√≠a fue resuelta" : "sin modificar el estado de la aver√≠a";
        
        showMessageBox(`Registro completado con √©xito. Fecha actualizada a ${newFecha}, ${completionStatus}.`, false);
        
        // Recargar la p√°gina para mostrar los datos actualizados
        setTimeout(() => {
            window.location.reload(); 
        }, 1500);

    } catch (error) {
        console.error("Error al completar la reparaci√≥n:", error);
        showMessageBox(`Error al procesar: ${error.message}. Intenta de nuevo.`, true);
    }
}


// --- Inicializaci√≥n (Nueva estructura para el script de Firebase) ---

/** * Funci√≥n global que encapsula toda la l√≥gica de inicializaci√≥n y listeners. 
 * Esta funci√≥n es llamada por el script de Firebase solo despu√©s de que 
 * la autenticaci√≥n an√≥nima se ha completado.
 */
window.initializePageLogic = function() {
    
    // 1. Inicializaci√≥n de las referencias al DOM del modal (CLAVE)
    modal = document.getElementById('confirmationModal'); 
    modalTitle = document.getElementById('modalTitle');
    modalMessage = document.getElementById('modalMessage');
    btnYes = document.getElementById('btnYes');
    btnNo = document.getElementById('btnNo');
    btnCancel = document.getElementById('btnCancel');
    
    // Referencias a botones principales
    const backBtn = document.getElementById('backBtn');
    const editDetailsBtn = document.getElementById('editDetailsBtn'); 
    const deleteBtn = document.getElementById('deleteDamageBtn'); 
    const completeBtn = document.getElementById('completeDamageBtn');
    const saveObservationsForm = document.getElementById('saveObservationsForm');
    const editDamageForm = document.getElementById('editDamageForm');
    const observationsTextarea = document.getElementById('detailObservaciones');
    const saveObservationsBtn = document.getElementById('saveObservationsBtn');

    // --- 2. ASIGNACI√ìN DE EVENT LISTENERS ---

    // Navegaci√≥n
    if (backBtn) {
        backBtn.addEventListener('click', function() {
            window.location.href = '../Repairs/Repairs.html'; 
        });
    }

    // Toggle de Modo Edici√≥n
    if (editDetailsBtn) {
        editDetailsBtn.addEventListener('click', function() {
            const isActive = this.classList.contains('active');
            enableEditMode(!isActive);
        });
    } else {
        console.error("ERROR CR√çTICO: No se encontr√≥ el bot√≥n de Edici√≥n ('editDetailsBtn'). Verifica el HTML.");
    }
    
    // Guardar Edici√≥n Principal
    if (editDamageForm) {
        editDamageForm.addEventListener('submit', handleSavePrimaryDetails);
    }
    
    // Guardar Observaciones
    if (saveObservationsForm) {
        saveObservationsForm.addEventListener('submit', handleSaveObservations);
    }
    
    // Control de visibilidad del bot√≥n Guardar Observaciones
    if (observationsTextarea && saveObservationsBtn) {
        observationsTextarea.addEventListener('input', function() {
            const currentValue = this.value;
            if (currentValue !== currentInitialObservations) { 
                saveObservationsBtn.classList.remove('hidden');
            } else {
                saveObservationsBtn.classList.add('hidden');
            }
        });
    }

    // Botones de ACCI√ìN PRINCIPALES (Abrir Modal)
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            showConfirmationModal('delete');
        });
    }

    if (completeBtn) {
        completeBtn.addEventListener('click', function() {
            showConfirmationModal('complete');
        });
    }

    // Botones dentro del MODAL (Manejar Confirmaci√≥n)
    if (btnYes) {
        btnYes.addEventListener('click', function() {
            console.log("DEBUG: Bot√≥n SI pulsado. Lanzando handleConfirmation(true)");
            handleConfirmation(true); 
        });
    }
    if (btnNo) {
        btnNo.addEventListener('click', function() {
            console.log("DEBUG: Bot√≥n NO pulsado. Lanzando handleConfirmation(false)");
            handleConfirmation(false);
        });
    }
    if (btnCancel) {
        btnCancel.addEventListener('click', hideConfirmationModal);
    }
    
    // Cargar los detalles de la aver√≠a
    loadDamageDetails();
};