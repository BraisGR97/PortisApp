<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortisApp - Detalle de Avería</title>
    <link rel="stylesheet" href="../Damage/Damage.css">
    </head>
<body>
    <div class="card-container">
        <div class="card">
            
            <div class="card-header-controls"> 
                <button class="btn-secondary" id="backBtn">Volver a Reparaciones</button>
                <button id="editDetailsBtn" class="modal-edit-btn">&#9998;</button> 
            </div>
            
            <h2>Detalle de la Avería</h2>
            <div id="damageMessageBox" class="message-box hidden" role="alert" aria-live="assertive"></div>
            
            <div id="detailView" class="detail-info"> 
                <p><strong>Ubicación:</strong> <span id="detailUbicacion">Cargando...</span></p>
                <p><strong>Modelo:</strong> <span id="detailModelo"></span> | <strong>Llave:</strong> <span id="detailLlave"></span></p>
                <p><strong>Contrato:</strong> <span id="detailContrato"></span> | <strong>Mes/Año:</strong> <span id="detailFecha"></span></p>
                <p><strong>Avería:</strong> <span id="detailAveria"></span></p>
            </div>

            <form id="editDamageForm" class="hidden"> 
                <div class="detail-info">
                    <div class="detail-group">
                        <label for="inputUbicacion">Ubicación:</label>
                        <input type="text" id="inputUbicacion" class="detail-input" required>
                    </div>
                    <div class="detail-inline-group">
                        <div class="detail-group">
                            <label for="inputModelo">Modelo:</label>
                            <input type="text" id="inputModelo" class="detail-input">
                        </div>
                        <div class="detail-group">
                            <label for="inputLlave">Llave:</label>
                            <input type="text" id="inputLlave" class="detail-input">
                        </div>
                    </div>
                    <div class="detail-inline-group">
                        <div class="detail-group">
                            <label for="inputContrato">Contrato:</label>
                            <select id="inputContrato" class="detail-input" required>
                                <option value="mensual">Mensual</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div class="detail-group">
                            <label for="inputFecha">Mes/Año:</label>
                            <input type="month" id="inputFecha" class="detail-input" required>
                        </div>
                    </div>
                    <div class="detail-group">
                        <label for="inputAveria">Avería:</label>
                        <textarea id="inputAveria" class="detail-input" rows="3"></textarea>
                    </div>

                    <button type="submit" id="savePrimaryDetailsBtn" class="btn-submit-green small hidden">Guardar Cambios</button>
                </div>
            </form>
            
            <hr>

            <form id="saveObservationsForm">
                <h3>Observaciones</h3>
    
                <div class="input-group">
                    <textarea id="detailObservaciones" class="detail-input" placeholder="Añadir observaciones, notas o seguimiento." rows="4"></textarea> 
                </div>
    
                <button type="submit" id="saveObservationsBtn" class="btn-submit-green small hidden">Guardar Observaciones</button>
            </form>

            <div class="button-group detail-actions-bottom flex-row-equal">
                <button id="deleteDamageBtn" class="btn-delete-action">Eliminar Avería</button> 
                <button id="completeDamageBtn" class="btn-submit-green">Completar</button>
            </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-overlay hidden">
        <div id="modalCard" class="modal-card">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            
            <div class="modal-actions">
                <button id="btnYes" class="btn-modal-yes">
                    Sí
                </button>
                
                <button id="btnNo" class="btn-modal-no">
                    No
                </button>

                <button id="btnCancel" class="btn-modal-cancel hidden">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="../Damage/Damage.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDoc, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyD_tC3KaK3UVyNOPiSsnI0s5k8Cd_qFJpg",
            authDomain: "portisapp.firebaseapp.com",
            projectId: "portisapp",
            storageBucket: "portisapp.firebasestorage.app",
            messagingSenderId: "38313359657",
            appId: "1:38313359657:web:ae73a0f8f7556bed92df38",
            measurementId: "G-HQ29Y8Z2DY"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Exponer referencias necesarias a Damage.js (Esto es vital)
        window.db = db;
        window.getDoc = getDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.addDoc = addDoc;
        // Se ha eliminado la llamada directa a window.initializePageLogic() de aquí

        // Función para iniciar sesión anónimamente
        function ensureAuth() {
            signInAnonymously(auth).catch(error => console.error("Error en autenticación anónima:", error));
        }
                
        // Obtener el ID del usuario AL CARGAR EL ESTADO
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.CURRENT_USER_ID = user.uid;
                console.log(`DEBUG: Autenticación exitosa. UID: ${user.uid}`);
                
                // CLAVE: Llama a la inicialización de la página (que llama a loadDamageDetails)
                // SOLO después de que el usuario esté listo, y ahora la función existe.
                if (typeof window.initializePageLogic === 'function') {
                    window.initializePageLogic();
                }

            } else {
                console.warn("Usuario no autenticado. Intentando autenticar...");
                ensureAuth();  
            }
        });

        // Llamamos a ensureAuth por primera vez si la sesión no estaba persistida
        ensureAuth();
    </script>
</body>
</html>